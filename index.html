<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Inspection â€” Mobile Form â†’ PDF</title>
  <style>
    :root{--brand:#005EB8;--brand-dark:#0b4ea2;--ink:#111827;--muted:#6b7280;--bg:#f7fafc;--card:#ffffff;--ok:#16a34a;--no:#b91c1c;--na:#6b7280}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(17,24,39,.06);padding:14px 14px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .logo{display:flex;align-items:center;gap:10px}
    .wordmark{height:32px;display:inline-block}
    h1{font-size:20px;margin:4px 0}
    .strap{font-size:12px;color:#374151;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
    label{font-size:13px;color:#374151;margin-bottom:4px;display:block}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:84px}
    .sec{margin:14px 0;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .sec h3{margin:0;padding:10px 12px;background:#f1f5f9;color:#0f172a;font-size:14px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .q{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 12px;border-top:1px solid #f1f5f9}
    .q:first-of-type{border-top:0}
    .qtext{font-size:14px}
    .pillset{display:flex;gap:6px;align-items:center}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;cursor:pointer;user-select:none;font-size:13px}
    .pill[data-v="yes"].active{background:rgba(22,163,74,.08);border-color:var(--ok);color:var(--ok)}
    .pill[data-v="no"].active{background:rgba(185,28,28,.08);border-color:var(--no);color:var(--no)}
    .pill[data-v="na"].active{background:rgba(107,114,128,.08);border-color:var(--na);color:var(--na)}
    .addnote{border:none;background:#eef2ff;color:var(--brand-dark);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .note{display:none;margin-top:10px}
    .note.show{display:block}
    .note textarea{background:#f9fafb}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;width:70px;height:70px;background:#f8fafc}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb button{position:absolute;top:2px;right:2px;border:none;background:rgba(0,0,0,.55);color:#fff;border-radius:6px;padding:2px 6px;font-size:10px;cursor:pointer}
    .iconbtn{border:none;background:#ecfeff;color:#0b4ea2;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .pillset .count{font-size:12px;color:#6b7280;margin-left:4px}
    .toolbar{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-top:1px solid #e5e7eb;padding:10px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid #cbd5e1}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .sigPreview{margin-top:8px;font-family:'Brush Script MT', 'Segoe Script', cursive;font-size:28px;color:#1f2937}
    .sigHelp{font-size:12px;color:#6b7280;margin-top:4px}
  </style>
  <!-- pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="logo" aria-label="Costain">
          <img class="wordmark" src="https://www.costain.com/media/tvpjxypz/logo.svg" alt="Costain Logo"/>
          <div>
            <div class="strap small muted">Together we shape, create, deliver</div>
            <h1>Site Inspection</h1>
          </div>
        </div>
      </header>

      <section class="grid" id="meta">
        <div>
          <label>Contractor</label>
          <input name="contractor" />
        </div>
        <div>
          <label>Site</label>
          <input name="site" />
        </div>
        <div>
          <label>Inspection by</label>
          <input name="inspector" />
        </div>
        <div>
          <label>Date</label>
          <input name="date" type="date" />
        </div>
        <div>
          <label>PCW</label>
          <input name="pcw" />
        </div>
        <div>
          <label>Project Manager</label>
          <input name="pm" />
        </div>
      </section>

      <div id="sections"></div>

      <!-- Signature Section -->
      <section class="sec" id="signatureSection">
        <h3>Signature</h3>
        <div class="q">
          <div>
            <label class="small muted" for="signatureName">Type your name to sign</label>
            <input name="signatureName" id="signatureName" placeholder="Full name" />
            <div class="sigPreview"><span id="sigPreviewText">Your Signature</span></div>
            <div class="sigHelp">Your typed name will appear on the PDF with todayâ€™s date.</div>
          </div>
        </div>
      </section>

      <div class="toolbar">
        <button class="btn btn-outline" id="clearBtn">Clear All</button>
        <button class="btn btn-primary" id="pdfPreviewBtn">Preview PDF</button>
        <button class="btn btn-outline" id="pdfDownloadBtn">Download PDF</button>
      </div>
      <p class="small muted">Tip: You can add this page to your phoneâ€™s Home Screen for quick access. Answers are kept in the page until you clear them.</p>
    </div>
  </div>

<script>
// Wrap everything so we don't leak globals (fixes duplicate variable errors on re-run)
(function(){
  'use strict';

  // ===== Schema of sections & questions (from your screenshots) =====
  const SCHEMA = [
    { title: '1 Â· CDM', items: [
      'Have the RAMS been reviewed by Costain and the PCW?',
      'Are the RAMS relevant to the work being carried out?',
      'Are the contractors CPP available and up to date?',
      'Does the job require an F10 Notification of Construction Project, and if so, is this available and up to date?',
      'Is the contractors HSEQ safety information clearly displayed?'
    ]},
    { title: '2 Â· Permits', items: [
      'Is the UU SHED in place and relevant documentation up to date?',
      'Has the contractor been issued an MSP lift permit?',
      'Has the contractor issued a permit to dig, where applicable?'
    ]},
    { title: '3 Â· Induction / Competencies', items: [
      'Have site inductions been carried out and evidenced?',
      'Are all competency certificates available? This includes electronically.',
      'Are the medical certificates available and valid?',
      'Are there enough adequately trained first aiders on-site?',
      'Is the site foreman SSSTS/ SMSTS trained?',
      'Are plant operator inductions required?',
      'Are the workforce aware of the Fire Assembly Point?'
    ]},
    { title: '4 Â· PPE', items: [
      'Is the MSP 6 point PPE being worn?',
      'Is the PPE worn task specific, and adequate for each task?'
    ]},
    { title: '5 Â· Welfare', items: [
      'Are there appropriate welfare facilities available on-site, and are these well maintained?',
      'Are the workforce satisfied with their welfare facilities?',
      'Are there drying rooms available for PPE?'
    ]},
    { title: 'General Checks', items: [
      'Are there fire extinguishers available, and valid?',
      'Is the first aid equipment clearly visible and adequately stocked?',
      'Are all electrical appliances PAT tested?',
      'Is there adequate lighting, via access and exit points?'
    ]},
    { title: '6 Â· Plant & Equipment', items: [
      'Is all plant on-site certified?',
      'Are daily plant inspections being carried out and evidenced?',
      'Are LOLER and PUWER of work equipment evidenced?'
    ]},
    { title: '7 Â· Environmental', items: [
      'Is the site tidy?',
      'Is waste segregated and in correct skips?',
      'Is the waste carrier licence evidenced?',
      'Are SPILL kits and plant nappies with liners available on-site?',
      "Are the 11 C's being evidenced?"
    ]},
    { title: '8 Â· Vehicle Movements / Traffic Management', items: [
      'Are vehicle movements safely controlled with adequate segregation?',
      'Is a TM management plan in place?'
    ]},
    { title: '9 Â· Pedestrian Safety', items: [
      'Is pedestrian safety appropriately controlled, including access egress, signage, walkways, and segregation?'
    ]},
    { title: "10 Â· Quality ITP's / Check Sheets", items: [
      "Are ITP's / checklists in place?",
      'Is the quality of work up to standard?'
    ]},
    { title: '11 Â· Isolation & Site Security', items: [
      'Is the UU equipment isolated?',
      'Is the CNT 600 and LOTO evidenced?',
      'Is site security under UU control?'
    ]},
    { title: '12 Â· Mental Health & Wellbeing', items: [
      'Are the workforce aware of who the MSP mental health first aiders are?',
      'Is there anything I can do to help?'
    ]},
    { title: '13 Â· Emergencies', items: [
      'Is there an emergency plan in place?',
      'Is there a defibrillator available, and is the workforce aware of the location?',
      'Is what3words available?',
      'Is a practice for an emergency situation required?'
    ]},
  ];

  // ===== Render form =====
  const sectionsEl = document.getElementById('sections');
  SCHEMA.forEach((sec, sIdx)=>{
    const secEl = document.createElement('section');
    secEl.className = 'sec';
    secEl.innerHTML = `<h3>${sec.title}<span class="muted small">YES / NO / N/A Â· Add notes</span></h3>`;
    sec.items.forEach((q, qIdx)=>{
      const id = `s${sIdx}q${qIdx}`;
      const qEl = document.createElement('div');
      qEl.className = 'q';
      qEl.innerHTML = `
        <div>
          <div class="qtext">${q}</div>
          <div class="note" id="${id}-note">
            <label class="small muted">Notes / Actions</label>
            <textarea data-bind="note" data-id="${id}" placeholder="Add details, actions, names, etc."></textarea>
          </div>
        </div>
        <div>
          <div class="pillset" role="group" aria-label="choices">
            <span class="pill" data-id="${id}" data-v="yes">Yes</span>
            <span class="pill" data-id="${id}" data-v="no">No</span>
            <span class="pill" data-id="${id}" data-v="na">N/A</span>
            <button class="addnote" type="button" data-id="${id}">ï¼‹</button>
            <button class="iconbtn addphoto" type="button" data-id="${id}" title="Add photo">ðŸ“·</button>
            <input class="photo-input" type="file" accept="image/*" capture="environment" data-id="${id}" multiple style="display:none" />
            <span class="count small" id="${id}-photocount"></span>
          </div>
          <div class="thumbs" id="${id}-thumbs"></div>
        </div>`;
      secEl.appendChild(qEl);
    });
    sectionsEl.appendChild(secEl);
  });

  // ===== State & helpers =====
  const STATE = JSON.parse(localStorage.getItem('siteInspectionState')||'{}');
  function save(){
    try { localStorage.setItem('siteInspectionState', JSON.stringify(STATE)); }
    catch(e){ console.warn('Save failed (likely storage quota). Photos will not be persisted.', e); alert('Storage is full. New photos will not be saved between refreshes, but will still go into the PDF.'); }
  }

  function setChoice(id, val){
    STATE[id] = STATE[id] || {}; STATE[id].choice = val; save();
    document.querySelectorAll(`.pill[data-id="${id}"]`).forEach(p=>{
      p.classList.toggle('active', p.dataset.v===val);
    });
  }
  function toggleNote(id){
    const box = document.getElementById(`${id}-note`);
    box.classList.toggle('show');
  }
  function setNote(id, text){ STATE[id] = STATE[id] || {}; STATE[id].note = text; save(); }

  // ===== Events =====
  sectionsEl.addEventListener('click', e=>{
    const pill = e.target.closest('.pill');
    if(pill){ setChoice(pill.dataset.id, pill.dataset.v); return; }
    const plus = e.target.closest('.addnote');
    if(plus){ toggleNote(plus.dataset.id); return; }
    const cam = e.target.closest('.addphoto');
    if(cam){ const input = sectionsEl.querySelector(`input.photo-input[data-id="${cam.dataset.id}"]`); if(input) input.click(); return; }
    const del = e.target.closest('.thumb button[data-del]');
    if(del){ const id = del.getAttribute('data-id'); const idx = parseInt(del.getAttribute('data-del'),10); removePhoto(id, idx); return; }
  });

  sectionsEl.addEventListener('input', e=>{
    if(e.target.matches('textarea[data-bind="note"]')){ setNote(e.target.dataset.id, e.target.value); }
  });

  sectionsEl.addEventListener('change', async (e)=>{
    const input = e.target.closest('input.photo-input');
    if(!input) return;
    const id = input.dataset.id;
    const files = Array.from(input.files||[]);
    for(const file of files){ await addPhoto(id, file); }
    input.value = '';
  });

  // ===== Restore UI from STATE =====
  function renderThumbs(id){
    const holder = document.getElementById(`${id}-thumbs`);
    const count = document.getElementById(`${id}-photocount`);
    const list = (STATE[id] && STATE[id].photos) ? STATE[id].photos : [];
    if(holder){
      holder.innerHTML = '';
      list.forEach((src, i)=>{
        const d = document.createElement('div'); d.className='thumb';
        d.innerHTML = `<img src="${src}" alt="Photo ${i+1}"><button data-del="${i}" data-id="${id}" title="Remove">Ã—</button>`;
        holder.appendChild(d);
      });
    }
    if(count){ count.textContent = list.length ? `ðŸ“· ${list.length}` : ''; }
  }

  function restore(){
    Object.entries(STATE).forEach(([id, v])=>{
      if(v && v.choice){ document.querySelectorAll(`.pill[data-id="${id}"]`).forEach(p=>{p.classList.toggle('active', p.dataset.v===v.choice)}); }
      if(v && v.note){ const box = document.getElementById(`${id}-note`); if(box){ box.classList.add('show'); const ta=box.querySelector('textarea'); if(ta) ta.value = v.note; } }
      if(v && v.photos){ renderThumbs(id); }
    });
    // meta
    const meta = document.querySelectorAll('#meta input');
    meta.forEach(i=>{ if(STATE.meta?.[i.name]) i.value = STATE.meta[i.name]; });
    // signature
    if(STATE.signatureName){ const inp = document.getElementById('signatureName'); const prev = document.getElementById('sigPreviewText'); if(inp){ inp.value = STATE.signatureName; } if(prev){ prev.textContent = STATE.signatureName; }}
  }
  restore();

  // ===== Photos API =====
  const MAX_PHOTOS_PER_Q = 2; // keep PDFs light + avoid storage issues
  const MAX_DIM = 1280; // px
  const JPEG_QUALITY = 0.8;

  async function addPhoto(id, file){
    STATE[id] = STATE[id] || {};
    STATE[id].photos = STATE[id].photos || [];
    if(STATE[id].photos.length >= MAX_PHOTOS_PER_Q){ alert('Max photos reached for this question.'); return; }
    const dataUrl = await compressImage(file, MAX_DIM, JPEG_QUALITY);
    STATE[id].photos.push(dataUrl);
    renderThumbs(id);
    save();
  }
  function removePhoto(id, idx){
    if(!STATE[id] || !STATE[id].photos) return;
    STATE[id].photos.splice(idx,1);
    renderThumbs(id);
    save();
  }
  async function compressImage(file, maxDim=1280, quality=0.85){
    const img = await readImage(file);
    const [w,h] = [img.width, img.height];
    const scale = Math.min(1, maxDim/Math.max(w,h));
    const cw = Math.round(w*scale), ch = Math.round(h*scale);
    const canvas = document.createElement('canvas'); canvas.width=cw; canvas.height=ch;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, cw, ch);
    return canvas.toDataURL('image/jpeg', quality);
  }
  function readImage(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{ const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src = reader.result; };
      reader.onerror = reject; reader.readAsDataURL(file);
    });
  }

  // ===== Meta & Signature persistence =====
  document.getElementById('meta').addEventListener('input', e=>{
    STATE.meta = STATE.meta || {}; STATE.meta[e.target.name] = e.target.value; save();
  });

  const sigInput = document.getElementById('signatureName');
  const sigPreview = document.getElementById('sigPreviewText');
  function updateSignature(val){
    STATE.signatureName = val; save();
    if(sigPreview){ sigPreview.textContent = val || 'Your Signature'; }
  }
  sigInput.addEventListener('input', (e)=> updateSignature(e.target.value));

  // ===== Clear =====
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('Clear all answers?')){ localStorage.removeItem('siteInspectionState'); location.reload(); }
  });

  // ===== PDF generation =====
  function buildPdfDoc(){
    const meta = STATE.meta || {};
    const today = new Date().toISOString().slice(0,10);

    // Header with SVG (pdfmake supports inline svg)
    const header = {
      columns:[
        { svg:
          '<svg viewBox="0 0 156 40" width="156" height="40" xmlns="http://www.w3.org/2000/svg">\
            <rect x="0" y="6" width="66" height="28" fill="#0B4EA2"/>\
            <rect x="66" y="6" width="6" height="28" fill="#0B4EA2"/>\
            <rect x="72" y="6" width="84" height="28" fill="#E5EAF4"/>\
            <rect x="76" y="10" width="76" height="20" fill="#005EB8"/>\
            <text x="114" y="25" font-family="Arial" font-weight="700" font-size="14" fill="#ffffff" text-anchor="middle">COSTAIN</text>\
          </svg>'
        },
        {text:'Site Inspection', style:'h1', alignment:'right'}
      ]
    };

    const metaTable = {
      table:{ widths:['*','*','*','*'], body:[
        [{text:'Contractor',style:'th'},{text:meta.contractor||'',style:'td'},{text:'Site',style:'th'},{text:meta.site||'',style:'td'}],
        [{text:'Inspection by',style:'th'},{text:meta.inspector||'',style:'td'},{text:'Date',style:'th'},{text:meta.date||today,style:'td'}],
        [{text:'PCW',style:'th'},{text:meta.pcw||'',style:'td'},{text:'Project Manager',style:'th'},{text:meta.pm||'',style:'td'}],
      ]}, layout:'lightHorizontalLines'
    };

    const sections = [];
    SCHEMA.forEach((sec, sIdx)=>{
      sections.push({text: sec.title, style:'h2', margin:[0,10,0,4]});
      const rows = [[{text:'Question',style:'th'},{text:'Answer',style:'th', alignment:'center'},{text:'Notes / Actions',style:'th'}]];
      sec.items.forEach((q,qIdx)=>{
        const id = `s${sIdx}q${qIdx}`;
        const ans = (STATE[id]?.choice||'').toUpperCase();
        const note = STATE[id]?.note || '';
        const photos = (STATE[id]?.photos||[]);
        const photoBadge = photos.length ? ` (ðŸ“· ${photos.length})` : '';
        rows.push([{text:q,style:'td'},{text:(ans+photoBadge).trim(),style:'td', alignment:'center'},{text:note,style:'td'}]);
      });
      sections.push({table:{widths:['*',60,'*'], body:rows}, layout:'lightHorizontalLines'});
    });

    // Photos gallery per question (after tables)
    const photoSections = [];
    SCHEMA.forEach((sec, sIdx)=>{
      sec.items.forEach((q,qIdx)=>{
        const id = `s${sIdx}q${qIdx}`;
        const photos = (STATE[id]?.photos)||[];
        if(photos.length){
          const photoBoxes = photos.map((p, idx)=>({
            stack:[
              { table: { body: [[{ image:p, width:180 }]] }, layout:{
                  hLineWidth:()=>1, vLineWidth:()=>1,
                  hLineColor:()=> '#cbd5e1', vLineColor:()=> '#cbd5e1'
                }
              },
              { text:`Q: ${q}`, style:'photoCap', margin:[0,4,0,0] }
            ], margin:[0,4,12,8]
          }));

          photoSections.push({
            table:{ widths:['*'], body:[
              [ {text:q, style:'th'} ],
              [ { columns: photoBoxes } ]
            ]},
            layout:{
              hLineWidth:(i)=> i===0?1:0.5,
              vLineWidth:()=>0,
              hLineColor:()=> '#e5e7eb'
            },
            margin:[0,6,0,6]
          });
        }
      });
    });
    if(photoSections.length){
      sections.push({text:'Photos', style:'h2', margin:[0,14,0,4]});
      sections.push(...photoSections);
    }

    // Signature block
    const sigName = STATE.signatureName || '';
    const signDate = meta.date || today;
    sections.push({
      margin:[0,14,0,0],
      table:{
        widths:['*','*'],
        body:[
          [
            {text:`Signed by: ${sigName || '[Not signed]'}`, border:[false,false,false,false]},
            {text:`Date: ${signDate}`, alignment:'right', border:[false,false,false,false]}
          ]
        ]
      },
      layout:'noBorders'
    });

    return {
      pageMargins:[28,36,28,36],
      content: [header,{text:' ',margin:[0,6]}, metaTable].concat(sections),
      styles:{
        h1:{fontSize:18,bold:true,color:'#0b4ea2'},
        h2:{fontSize:12,bold:true,color:'#0b4ea2'},
        th:{bold:true, fillColor:'#eef2ff'},
        td:{margin:[2,4,2,4]},
        photoCap:{fontSize:8,color:'#6b7280'}
      },
      defaultStyle:{fontSize:9}
    };
  }

  function openPdf(){ pdfMake.createPdf(buildPdfDoc()).open(); }
  function downloadPdf(){
    const meta = STATE.meta || {}; const date = meta.date || new Date().toISOString().slice(0,10);
    const site = (meta.site||'Site').replace(/[^A-Za-z0-9-_]+/g,'_');
    const fname = `Site-Inspection_${site}_${date}.pdf`;
    pdfMake.createPdf(buildPdfDoc()).download(fname);
  }

  document.getElementById('pdfPreviewBtn').addEventListener('click', openPdf);
  document.getElementById('pdfDownloadBtn').addEventListener('click', downloadPdf);

  // ===== Lightweight self-tests (run once, console only) =====
  (function selfTests(){
    try {
      console.assert(Array.isArray(SCHEMA) && SCHEMA.length >= 10, 'SCHEMA should contain sections');
      const rendered = document.querySelectorAll('#sections .sec').length;
      console.assert(rendered === SCHEMA.length, `Rendered sections (${rendered}) should equal schema length (${SCHEMA.length})`);
      const doc = buildPdfDoc();
      console.assert(doc && doc.content && doc.styles, 'PDF doc definition should be created');
      console.assert(typeof (STATE.signatureName ?? '') === 'string', 'Signature should be a string');
      console.assert(!!document.getElementById('pdfPreviewBtn') && !!document.getElementById('pdfDownloadBtn'), 'PDF buttons should exist');
      // Added tests for photo widgets on first question
      const firstId = 's0q0';
      const pillset = document.querySelector(`.pillset span.pill[data-id="${firstId}"]`);
      const addPhotoBtn = document.querySelector(`button.addphoto[data-id="${firstId}"]`);
      console.assert(!!pillset && !!addPhotoBtn, 'Pills and photo button should exist on first question');
      console.info('Self-tests passed: schema, DOM render, PDF builder, signature, photo widgets OK');
    } catch (e) {
      console.warn('Self-tests failed:', e);
    }
  })();
})();
</script>
</body>
</html>
